<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>

  <style type="text/css">
    div {
      box-sizing: border-box;
    }

    .spot {
      position: absolute;
      width: 10px;
      height: 10px;
      background: lightblue;
    }

    .food {
      background: seagreen;
    }

    .playground {
      position: relative
    }
  </style>
</head>
<body>
  <div id="playground" tabindex="0" style="width: 600px; height: 400px; border: 1px solid salmon"></div>
  <button onclick="game.start()">start</button>
  <button onclick="game.stop()">stop</button>
  <script type="text/javascript">
    function Position (x, y) {
      this.x = x; this.y = y;
    }

    Position.prototype.set = function (x, y) {
      this.x = x; this.y = y;
    }

    function Spot (parent, position) {
      this.position = position
      const el = document.createElement("div")
      el.classList.add("spot")
      this.parent = parent
      parent.el.appendChild(el)
      this.el = el
      this.move()
    }

    Spot.prototype.move = function () {
      const { x, y } = this.position
      this.el.style.transform = `translate(${x}px,${y}px)`
    }

    function Food (parent, position) {
      Spot.call(this, parent, position)
    }

    Food.prototype = Object.create(Spot.prototype)
    Food.prototype.constructor = Food

    function Snake (...spots) {
      this.spots = spots
      this.step = 2
      this.deltaX = this.step
      this.deltaY = 0
    }

    Snake.size = 10

    Snake.prototype.move = function (deltaX, deltaY) {
      this.deltaX = deltaX
      this.deltaY = deltaY

      const head = this.spots[this.spots.length - 1]
      for (let i = 0; i < this.spots.length - 1; i++) {
        const prev = this.spots[i + 1]
        const current = this.spots[i]
        current.position.set(prev.position.x, prev.position.y)
        current.move()
      }

      const depart = Snake.size / this.step
      head.position.set(head.position.x + deltaX * depart, head.position.y + deltaY * depart)
      head.move()
    }

    Snake.prototype.eat = function () {}

    function Playground (width = 400, height = 300) {
      this.width = width
      this.height = height
      this.el = document.getElementById("playground");
      this.el.style.width = width + "px"
      this.el.style.height = height + "px"
    }
  </script>
  <script>
    const GameState = {
      init: 0,
      running: 1,
      pause: 2,
      stop: 3
    }

    function Game () {
      this.foods = []
      this.startTime = null
      this.previousTimeStamp = null
      this.playground = null
      this.snake = null
      this.init()
    }

    Game.prototype.createSnake = function () {
      const playground = this.playground
      const body = new Array(5).fill([0, 0]).map(function ([x, y], index) {
        return new Spot(playground, new Position(x + index * Snake.size, y))
      })
      const snake = new Snake(
        ...body
      )
      return snake
    }

    Game.prototype.init = function () {
      this.state = GameState.init

      this.playground = new Playground()
      const snake = this.createSnake()
      this.snake = snake
      this.initHandler()
      this.initFoods()
    }

    Game.prototype.initFoods = function (num = 10) {
      const random = Math.round(Math.random() * num)
      for (let i = random; i >= 0; i--) {
        this.createFood()
      }
    }

    // 优先距离蛇头 50 格内生成食物，并且不能生成在蛇身体上, 也不能生成到已有的食物身上
    Game.prototype.createFood = function () {
      let randomX = Math.round(Math.random() * this.playground.width)
      let randomY = Math.round(Math.random() * this.playground.height)

      // 去除不能整除的数字
      randomX = randomX - randomX % Snake.size
      randomY = randomY - randomY % Snake.size

      const occupiedPositions = this.snake.spots.concat(this.foods).map(spot => spot.position)
      // 查找当前位置是否可用，若不可用，则继续生成
      const food = new Food(this.playground, new Position(randomX, randomY))
      food.el.classList.add("food")
      this.foods.push(food)
    }

    Game.prototype.initHandler = function () {
      const snake = this.snake
      this.playground.el.addEventListener("keydown", function(e) {
        const step = snake.step
        switch(e.key) {
          case 'ArrowDown':
            snake.move(0, step)
            break
          case 'ArrowUp':
            snake.move(0, -step)
            break;
          case 'ArrowLeft':
            snake.move(-step, 0)
            break
          case 'ArrowRight':
            snake.move(step, 0)
            break
          default:
        }
        return false
      })
    }

    Game.prototype.start = function () {
      this.state = GameState.running
      window.requestAnimationFrame(this.run.bind(this))
    }

    Game.prototype.run = function (timestamp) {
      if (this.startTime === null) {
        this.startTime = timestamp;
      }
      const elapsed = timestamp - this.previousTimeStamp;
      if (this.previousTimeStamp == null || elapsed > 1000) {
        this.previousTimeStamp = timestamp;
        this.snake.move(this.snake.deltaX, this.snake.deltaY)
      }
      if (this.state === GameState.running) {
        window.requestAnimationFrame(this.run.bind(this));
      }
    }

    Game.prototype.pause = function () {
      this.state = GameState.pause
    }

    Game.prototype.stop = function () {
      this.state = GameState.stop
    }
  </script>
  <script>
    const game = new Game()
  </script>
</body>
</html>